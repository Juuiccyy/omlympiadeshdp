<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Les Olympiades du Havre de Paix (Live)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="module">
        // --- FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // Config Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAqUwG1JiprI7lKTuIggnHN5L5GYXHHQh0",
            authDomain: "olympiades-hdp.firebaseapp.com",
            projectId: "olympiades-hdp",
            storageBucket: "olympiades-hdp.firebasestorage.app",
            messagingSenderId: "707224340568",
            appId: "1:707224340568:web:5395f8d0c8ae48404ea22d"
        };
        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const playersCol = collection(db, "players");

        // --- ADMIN LOGIC ---
        let isAdmin = false;
        let adminModal = null;
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(showAdminModal, 100);
        });
        function showAdminModal() {
            if (document.getElementById('adminModal')) return;
            adminModal = document.createElement('div');
            adminModal.id = 'adminModal';
            adminModal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-70 z-50';
            adminModal.innerHTML = `
                <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl flex flex-col items-center max-w-xs w-full">
                    <h2 class="text-xl font-semibold text-white mb-4">Accès Admin</h2>
                    <input id="adminCodeInput" type="password" placeholder="Code admin" class="input-field w-full p-3 mb-4 text-lg" autocomplete="off">
                    <button id="adminSubmitBtn" class="btn btn-primary font-semibold w-full text-lg py-2 rounded-lg mb-2">Valider</button>
                    <button id="adminViewOnlyBtn" class="btn bg-gray-600 text-white w-full text-sm py-1 rounded-lg">Juste voir le leaderboard</button>
                    <p class="text-gray-400 mt-2 text-xs">Le code admin te permet d’ajouter ou modifier des scores.</p>
                </div>`;
            document.body.appendChild(adminModal);
            document.getElementById('adminSubmitBtn').onclick = () => {
                let code = document.getElementById('adminCodeInput').value.trim();
                if (code === "juju2025") {
                    isAdmin = true;
                    closeAdminModal();
                    updateAdminUI();
                } else {
                    document.getElementById('adminCodeInput').classList.add('border-red-500');
                }
            };
            document.getElementById('adminViewOnlyBtn').onclick = () => {
                isAdmin = false;
                closeAdminModal();
                updateAdminUI();
            };
            document.getElementById('adminCodeInput').onkeydown = (e) => {
                if (e.key === "Enter") document.getElementById('adminSubmitBtn').click();
            };
        }
        function closeAdminModal() {
            if (adminModal) {
                adminModal.remove();
                adminModal = null;
            }
        }
        function updateAdminUI() {
            // Activer/Désactiver les boutons selon le mode admin
            document.querySelectorAll('.admin-only').forEach(btn => btn.style.display = isAdmin ? '' : 'none');
            // Afficher le bouton de déconnexion admin
            const logoutBtn = document.getElementById('adminLogoutBtn');
            if (logoutBtn) logoutBtn.style.display = isAdmin ? '' : 'none';
        }

        // --- LEADERBOARD ---
        // Elements
        let addPlayerFormEl, playerNameInput, initialScoreInput, playerSelectUpdate, newScoreInput, replaceScoreButton, pointsToAddInput, addPointsButton, leaderboardTableBody, messageDiv, loadingMessageDiv, leaderboardTable, emptyLeaderboardMessageDiv, deleteModal, confirmDeleteBtn, cancelDeleteBtn, playerToDeleteId, toggleAddPlayerFormBtn, toggleUpdateScoreFormBtn, addPlayerSection, updateScoreSection, closeAddPlayerFormBtn, closeUpdateScoreFormBtn;
        let playersCache = [];

        window.addEventListener('DOMContentLoaded', () => {
            // Query selectors
            addPlayerFormEl = document.getElementById('addPlayerForm');
            playerNameInput = document.getElementById('playerName');
            initialScoreInput = document.getElementById('initialScore');
            playerSelectUpdate = document.getElementById('playerSelectUpdate');
            newScoreInput = document.getElementById('newScore');
            replaceScoreButton = document.getElementById('replaceScoreButton');
            pointsToAddInput = document.getElementById('pointsToAdd');
            addPointsButton = document.getElementById('addPointsButton');
            leaderboardTableBody = document.getElementById('leaderboardTableBody');
            messageDiv = document.getElementById('messageDiv');
            loadingMessageDiv = document.getElementById('loadingMessage');
            leaderboardTable = document.getElementById('leaderboardTable');
            emptyLeaderboardMessageDiv = document.getElementById('emptyLeaderboardMessage');
            deleteModal = document.getElementById('deleteConfirmationModal');
            confirmDeleteBtn = document.getElementById('confirmDeleteButton');
            cancelDeleteBtn = document.getElementById('cancelDeleteButton');
            toggleAddPlayerFormBtn = document.getElementById('toggleAddPlayerFormBtn');
            toggleUpdateScoreFormBtn = document.getElementById('toggleUpdateScoreFormBtn');
            addPlayerSection = document.getElementById('addPlayerSection');
            updateScoreSection = document.getElementById('updateScoreSection');
            closeAddPlayerFormBtn = document.getElementById('closeAddPlayerFormBtn');
            closeUpdateScoreFormBtn = document.getElementById('closeUpdateScoreFormBtn');

            // Ajouter bouton logout admin
            if (!document.getElementById('adminLogoutBtn')) {
                const logoutBtn = document.createElement('button');
                logoutBtn.id = "adminLogoutBtn";
                logoutBtn.textContent = "Déconnexion admin";
                logoutBtn.className = "btn bg-gray-700 text-white fixed top-4 right-4 py-2 px-4 rounded-lg shadow-lg z-50";
                logoutBtn.style.display = "none";
                logoutBtn.onclick = () => {
                    isAdmin = false;
                    updateAdminUI();
                    showAdminModal();
                };
                document.body.appendChild(logoutBtn);
            }

            // Gérer la visibilité admin
            document.querySelectorAll('.admin-only').forEach(btn => btn.style.display = 'none');
            updateAdminUI();

            // Gestion UI (forms)
            toggleAddPlayerFormBtn.onclick = () => { if (!isAdmin) return; addPlayerSection.style.display = 'block'; updateScoreSection.style.display = 'none'; setActiveButton(toggleAddPlayerFormBtn, toggleUpdateScoreFormBtn); addPlayerFormEl.reset(); };
            toggleUpdateScoreFormBtn.onclick = () => { if (!isAdmin) return; updateScoreSection.style.display = 'block'; addPlayerSection.style.display = 'none'; setActiveButton(toggleUpdateScoreFormBtn, toggleAddPlayerFormBtn); playerSelectUpdate.value = ""; newScoreInput.value = ""; pointsToAddInput.value = ""; };
            closeAddPlayerFormBtn.onclick = () => { addPlayerSection.style.display = 'none'; toggleAddPlayerFormBtn.classList.remove('active'); toggleAddPlayerFormBtn.classList.add('inactive'); };
            closeUpdateScoreFormBtn.onclick = () => { updateScoreSection.style.display = 'none'; toggleUpdateScoreFormBtn.classList.remove('active'); toggleUpdateScoreFormBtn.classList.add('inactive'); };

            // Event forms
            addPlayerFormEl.onsubmit = async (e) => {
                e.preventDefault();
                if (!isAdmin) return;
                const playerName = playerNameInput.value.trim();
                const score = parseInt(initialScoreInput.value);
                if (!playerName || isNaN(score)) { showMessage('Nom et score valides requis.', 'error'); return; }
                // Vérifier existence
                const exist = playersCache.find(p => p.name.toLowerCase() === playerName.toLowerCase());
                if (exist) { showMessage(`Un joueur nommé "${playerName}" existe déjà.`, 'error'); return; }
                await addDoc(playersCol, { name: playerName, score: score });
                showMessage('Joueur ajouté avec succès!', 'success');
                addPlayerFormEl.reset();
            };
            replaceScoreButton.onclick = async () => {
                if (!isAdmin) return;
                const playerId = playerSelectUpdate.value;
                const newScoreValue = newScoreInput.value;
                if (!playerId) { showMessage('Sélectionner un joueur.', 'error'); return; }
                if (newScoreValue === '' || isNaN(parseInt(newScoreValue))) { showMessage('Nouveau score valide requis.', 'error'); return; }
                const scoreToSet = parseInt(newScoreValue);
                const ref = doc(db, "players", playerId);
                await updateDoc(ref, { score: scoreToSet });
                showMessage('Score remplacé!', 'success');
                newScoreInput.value = '';
            };
            addPointsButton.onclick = async () => {
                if (!isAdmin) return;
                const playerId = playerSelectUpdate.value;
                const pointsString = pointsToAddInput.value;
                if (!playerId) { showMessage('Sélectionner un joueur.', 'error'); return; }
                if (pointsString === '' || isNaN(parseInt(pointsString))) { showMessage('Points valides requis.', 'error'); return; }
                const pointsNumber = parseInt(pointsString);
                const ref = doc(db, "players", playerId);
                const joueur = playersCache.find(p => p.id === playerId);
                if (joueur) {
                    await updateDoc(ref, { score: joueur.score + pointsNumber });
                    showMessage(`${pointsNumber >= 0 ? '+' : ''}${pointsNumber} points! Score: ${joueur.score + pointsNumber}`, 'success');
                    pointsToAddInput.value = '';
                }
            };
            confirmDeleteBtn.onclick = async () => {
                if (playerToDeleteId && isAdmin) {
                    const ref = doc(db, "players", playerToDeleteId);
                    await deleteDoc(ref);
                    showMessage('Joueur supprimé!', 'success');
                }
                closeDeleteModal();
            };
            cancelDeleteBtn.onclick = closeDeleteModal;
        });

        function setActiveButton(activeBtn, inactiveBtn) {
            activeBtn.classList.remove('inactive'); activeBtn.classList.add('active');
            inactiveBtn.classList.remove('active'); inactiveBtn.classList.add('inactive');
        }
        function showMessage(message, type = 'info', duration = 3000) {
            messageDiv.textContent = message;
            messageDiv.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white z-50';
            if (type === 'success') messageDiv.classList.add('bg-green-600');
            else if (type === 'error') messageDiv.classList.add('bg-red-600');
            else messageDiv.classList.add('bg-blue-600');
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; messageDiv.textContent = ''; }, duration);
        }
        function openDeleteModal(id) {
            playerToDeleteId = id;
            deleteModal.classList.remove('hidden'); deleteModal.classList.add('flex');
        }
        function closeDeleteModal() {
            deleteModal.classList.add('hidden'); deleteModal.classList.remove('flex');
            playerToDeleteId = null;
        }

        // --- FIREBASE REAL-TIME LISTEN ---
        function listenLeaderboard() {
            loadingMessageDiv.classList.remove('hidden');
            leaderboardTable.classList.add('hidden');
            emptyLeaderboardMessageDiv.classList.add('hidden');
            onSnapshot(playersCol, (snapshot) => {
                const players = [];
                snapshot.forEach(docu => players.push({ id: docu.id, ...docu.data() }));
                // Tri
                players.sort((a, b) => b.score === a.score ? a.name.localeCompare(b.name) : b.score - a.score);
                playersCache = players;
                renderLeaderboard(players);
                populatePlayerSelect(players);
                loadingMessageDiv.classList.add('hidden');
                if (players.length === 0) {
                    emptyLeaderboardMessageDiv.classList.remove('hidden');
                    leaderboardTable.classList.add('hidden');
                } else {
                    emptyLeaderboardMessageDiv.classList.add('hidden');
                    leaderboardTable.classList.remove('hidden');
                }
            });
        }

        function renderLeaderboard(players) {
            leaderboardTableBody.innerHTML = '';
            if (players.length === 0) return;
            players.forEach((player, index) => {
                const rank = index + 1;
                let medalDisplay = '', rankColorClass = 'text-gray-400';
                if (rank === 1) { medalDisplay = "🥇"; rankColorClass = 'text-yellow-400'; }
                else if (rank === 2) { medalDisplay = "🥈"; rankColorClass = 'text-gray-300'; }
                else if (rank === 3) { medalDisplay = "🥉"; rankColorClass = 'text-yellow-600'; }
                const row = leaderboardTableBody.insertRow();
                row.className = 'table-row';
                const medalCell = row.insertCell();
                medalCell.className = `px-3 py-4 whitespace-nowrap text-xl medal-cell ${rankColorClass}`;
                medalCell.textContent = medalDisplay;
                const rankCell = row.insertCell();
                rankCell.className = `px-3 py-4 whitespace-nowrap text-sm font-medium rank-cell ${rankColorClass}`;
                rankCell.textContent = rank.toString();
                const nameCell = row.insertCell();
                nameCell.className = `px-6 py-4 whitespace-nowrap text-sm ${rank <= 3 ? 'font-semibold text-gray-100' : 'text-gray-300'}`;
                nameCell.textContent = player.name;
                const scoreCell = row.insertCell();
                let scoreColorClass = 'text-gray-400';
                if (player.score > 0) scoreColorClass = 'text-green-400';
                else if (player.score < 0) scoreColorClass = 'text-red-400';
                scoreCell.className = `px-6 py-4 whitespace-nowrap text-sm font-medium ${scoreColorClass}`;
                scoreCell.textContent = player.score.toString();
                const actionsCell = row.insertCell();
                actionsCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-center');
                // Bouton supprimer uniquement admin
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteButton.title = "Supprimer ce joueur";
                deleteButton.className = 'btn btn-danger text-xs py-1.5 px-2.5 rounded-md hover:scale-105 admin-only';
                deleteButton.onclick = () => { if (!isAdmin) return; openDeleteModal(player.id); };
                actionsCell.appendChild(deleteButton);
            });
            updateAdminUI();
        }
        function populatePlayerSelect(players) {
            const currentSelectedValue = playerSelectUpdate.value;
            playerSelectUpdate.innerHTML = '<option value="">-- Choisir un joueur --</option>';
            const sortedPlayers = [...players].sort((a, b) => a.name.localeCompare(b.name));
            sortedPlayers.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = `${player.name} (Score: ${player.score})`;
                playerSelectUpdate.appendChild(option);
            });
            if (sortedPlayers.find(p => p.id === currentSelectedValue)) {
                playerSelectUpdate.value = currentSelectedValue;
            }
        }

        // On charge tout au démarrage
        window.addEventListener('DOMContentLoaded', () => {
            listenLeaderboard();
        });

    </script>
    <style>
    /* ... (mets ici tout ton style d'origine, inchangé) ... */
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-8 px-4 pb-8">
    <!-- ... (garde tout ton HTML, inchangé, sauf) ... -->
    <!-- Ajoute la classe "admin-only" à tous les boutons d’ajout/modif/suppression -->
    <!-- Exemple : -->
    <!--
    <button id="toggleAddPlayerFormBtn" class="btn toggle-btn inactive font-semibold py-2.5 px-5 rounded-lg shadow-lg admin-only">
        <i class="fas fa-user-plus mr-2"></i>Ajouter Joueur
    </button>
    -->
    <!-- Fais pareil pour :
        - #toggleUpdateScoreFormBtn
        - Les boutons supprimer
        - Les boutons dans les modales de score
    -->
    <!-- ... -->
</body>
</html>
